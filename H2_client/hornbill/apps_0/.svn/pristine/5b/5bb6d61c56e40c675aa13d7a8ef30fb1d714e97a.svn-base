/*common*/

/*
 Tab 组件

 html:
    <div class="js-tab">
        <div class="tab">
            <div class="js-tab-item">Tab-0</div>
            <div class="js-tab-item">Tab-1</div>
            <div class="js-tab-item">Tab-2</div>
        </div>

        <div class="js-tab-content"></div>
        <div class="js-tab-content"></div>
        <div class="js-tab-content"></div>
    </div>

    js-tab-item 与 js-tab-content 需要放置在 js-tab 下
 */

var $              = require( 'wap/zepto' ),
    NOOP           = function() {
        return true
    },

    TAB_PREFIX     = 'tab-',

    defaultConfig  = {
        autoInit:      true,
        rememberState: false,
        stateName:     'state',
        event:         'click',
        tab:           '.js-tab',
        'tab-item':    '.js-tab-item',
        content:       '.js-tab-content',
        activeClass:   'active',
        beforeChange:  NOOP,
        afterChange:   NOOP
    },

    needFixedProps = [ 'tab', 'tab-item', 'content', 'activeClass' ]

function Tab( config ) {
    this.init( this.config = config )
}

Tab.prototype = {
    constructor: Tab,

    init: function( config ) {
        this.fixClass( config )

        var $p        = $( config.tab ),
            $tabs     = $p.find( config[ 'tab-item' ] ),
            $contents = $p.find( config.content ),
            stName    = config.stateName,
            $curTab, $curContent

        if ( config.autoInit ) {
            $curTab = $tabs.filter( config.activeClass )

            if ( !$curTab.length ) {
                $curTab = $tabs.eq( 0 )
            }

            $curContent = $contents.eq( $curTab.index() )

            $curTab.addClass( config.activeClassValue )
            $contents.hide()
            $curContent.show()
        }

        this.els = {
            parent:     $p,
            tabs:       $tabs,
            contents:   $contents,
            curTab:     $curTab,
            curContent: $curContent
        }

        $( config.tab ).on( config.event, config[ 'tab-item' ], this.eventHandler.bind( this ) )

        if ( config.rememberState ) {
            $tabs.each( function( i, el ) {
                var $el = $( el )
                if ( !$el.data( stName ) ) {
                    $el.attr( 'data-' + stName, TAB_PREFIX + i )
                }
            } )

            this.handleState()
        }
    },

    handleState: function() {
        var hash   = location.hash,
            config = this.config,
            curTab

        if ( hash ) {
            hash   = hash.slice( 1 )
            curTab = this.els.tabs.filter( '[data-' + config.stateName + '="' + hash + '"]' )
            setTimeout( function() {
                curTab.trigger( config.event )
            }, 0 )
        }
    },

    fixClass: function( config ) {
        needFixedProps.map( function( value ) {
            config[ value ] = ( value = config[ value ].trim() ).indexOf( '.' ) == 0 ? value : ( '.' + value )
        } )

        config.activeClassValue = config.activeClass.substring( 1 )
    },

    eventHandler: function( e ) {
        var config           = this.config,
            els              = this.els,
            $el              = $( e.target ),
            isRememberState  = config.rememberState,
            activeClassValue = config.activeClassValue,
            $curContent

        if ( isRememberState ) {
            location.hash = $el.data( config.stateName )
        }

        if ( !$el.hasClass( activeClassValue ) ) {
            if ( !config.beforeChange( $el, els.curContent, config ) ) {
                return
            }

            els.curTab.removeClass( activeClassValue )
            els.curContent.hide()

            $el.addClass( activeClassValue )
            $curContent = els.contents.eq( $el.index() ).show()

            els.curTab     = $el
            els.curContent = $curContent

            config.afterChange( $el, $curContent, config )
        }
    },

    destroy: function() {
        var config = this.config
        $( config.tab ).off( config.event )
    }
}

exports.init = function( config ) {
    return new Tab( $.extend( true, defaultConfig, config ) )
}
